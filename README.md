# Automated Container Deployment and Administration in AWS
his GitHub Actions workflow automates the deployment of infrastructure and applications to AWS using Terraform and Ansible. The process is split into two major stages: Terraform is used to provision the infrastructure (e.g., EC2 instances, VPC, Security group etc), and Ansible is used to configure the EC2 instance and deploy Docker and an Nginx container using Docker.

**Workflow Triggers**

yaml
Copy
Edit
on:
  push:
    branches:
      - main
  workflow_dispatch:
This workflow runs on every push to the main branch or can be manually triggered via workflow dispatch.

**Environment Variables**

yaml
Copy
Edit
env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.11.2
AWS_REGION: Specifies the AWS region for the infrastructure (in this case, us-east-1).

TF_VERSION: Specifies the version of Terraform to use (1.11.2)
-----------------------------------------------------------------
**Jobs**
**1. Terraform Job**
Job Setup
yaml
Copy
Edit
jobs:
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
This job runs on an Ubuntu runner and applies the Terraform configuration to provision infrastructure.

**Steps in Terraform Job**
1. Checkout Repository

yaml
Copy
Edit
- name: Checkout Repository
  uses: actions/checkout@v4
Checks out the repository to access the code for Terraform and Ansible files.

2. Install Terraform

yaml
Copy
Edit
- name: Install Terraform
  run: |
    curl -O https://releases.hashicorp.com/terraform/${{ env.TF_VERSION }}/terraform_${{ env.TF_VERSION }}_linux_amd64.zip
    ...
    terraform -version
Downloads and installs the specified version of Terraform on the runner.

3. Configure AWS Credentials

yaml
Copy
Edit
- name: Configure AWS Credentials
  uses: aws-actions/configure-aws-credentials@v3
  with:
    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    ...
Configures the AWS credentials for interacting with the AWS API. Credentials are retrieved from GitHub secrets.

4. Initialize Terraform

yaml
Copy
Edit
- name: Initialize Terraform
  working-directory: terraform
  run: terraform init -upgrade
Initializes the Terraform working directory and upgrades the Terraform modules.

5. Validate Terraform

yaml
Copy
Edit
- name: Validate Terraform
  working-directory: terraform
  run: terraform validate
Validates the Terraform configuration to ensure there are no errors.

6. Apply Terraform Configuration

yaml
Copy
Edit
- name: Apply Terraform
  working-directory: terraform
  run: terraform apply -auto-approve
Applies the Terraform configuration to provision resources, such as EC2 instances, on AWS.
**At this stage main.tf is triggered. containing all the code for deployment of EC2 instance, VPC etc**

we need to wait for EC2 instance to be created on AWS

7. Wait for EC2 and Fetch Public IP

yaml
Copy
Edit
- name: Wait for EC2 and Fetch Public IP
  run: |
    INSTANCE_ID=$(aws ec2 describe-instances ...)
    ...
Waits for the EC2 instance to enter the running state and fetches the instance's public IP.

8. Upload EC2 IP as Artifact

yaml
Copy
Edit
- name: Upload EC2 IP as Artifact
  uses: actions/upload-artifact@v4
  with:
    name: ec2_ip
    path: ec2_ip.txt
Uploads the EC2 instance's public IP as an artifact, making it available to subsequent jobs.
------------------------------------------------------------------------
**2. Ansible Job**
Job Setup
yaml
Copy
Edit
ansible:
  name: Configure EC2 with Ansible
  runs-on: ubuntu-latest
  needs: terraform
This job runs after the Terraform job successfully completes and is responsible for configuring the EC2 instance using Ansible.

**Steps in Ansible Job**
1. Checkout Repository

yaml
Copy
Edit
- name: Checkout Repository
  uses: actions/checkout@v4
Checks out the repository to access the Ansible playbooks and inventory files.

2. Install Ansible

yaml
Copy
Edit
- name: Install Ansible
  run: |
    sudo apt update -y
    sudo apt install -y ansible
    ansible --version
Installs Ansible on the runner to enable running Ansible playbooks.

3. Download EC2 IP Artifact

yaml
Copy
Edit
- name: Download EC2 IP Artifact
  uses: actions/download-artifact@v4
  with:
    name: ec2_ip
Downloads the artifact containing the EC2 public IP generated by the Terraform job.

4. Set Up SSH Key

yaml
Copy
Edit
- name: Set Up SSH Key
  run: |
    mkdir -p ~/.ssh
    echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/labsuser.pem
    chmod 400 ~/.ssh/labsuser.pem
Sets up the SSH private key needed to access the EC2 instance.

5. Test SSH Connection

yaml
Copy
Edit
- name: Test SSH Connection
  run: ssh -i ~/.ssh/labsuser.pem -o StrictHostKeyChecking=no ec2-user@$EC2_IP "echo 'SSH Connection Successful'"
Tests the SSH connection to the EC2 instance using the private key.

6. Update Ansible Inventory

yaml
Copy
Edit
- name: Update Ansible Inventory
  run: |
    echo "[WebServer]" > ansible/inventory.ini
    echo "${{ env.EC2_IP }} ansible_user=ec2-user ansible_ssh_private_key_file=~/.ssh/labsuser.pem" >> ansible/inventory.ini
Updates the Ansible inventory file with the EC2 IP address and SSH credentials.

7. Run Ansible Playbook for Docker Installation

yaml
Copy
Edit
- name: Run Ansible Playbook for Docker Installation
  run: ansible-playbook -i ansible/inventory.ini ansible/install_docker.yml
Runs an Ansible playbook to install Docker on the EC2 instance.
check the install.docker.yml file for docker installation inside the ansible.

8. Run Ansible Playbook to Deploy Nginx Server

yaml
Copy
Edit
- name: Run Ansible Playbook to Deploy NGNIX server
  run: ansible-playbook -i ansible/inventory.ini ansible/deploy_container.yml
Runs an Ansible playbook to deploy an Nginx container using Docker on the EC2 instance.
deploy_container.yml has ngnix server deployment via docker.

**Summary**
This GitHub Actions workflow automates the entire process of provisioning AWS resources with Terraform and installing docker and deploying NGNIX server on the EC2 instance. 
